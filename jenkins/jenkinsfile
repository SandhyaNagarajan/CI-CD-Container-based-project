node {

  stage('test Server') {
    // 08.08.2018 : checking out code from git and after entering into <webapp>
    // run the script: Run_from_scratch.sh (which runs docker-compose for whole project)
    sh "touch checkout_run.sh"
    sh "echo git clone https://github.com/SandhyaNagarajan/CI-CD-Container-based-project/ > checkout_run.sh"
    sh "echo cd CI-CD-Container-based-project/ecommerce-webapp >> checkout_run.sh"
    sh "echo docker-compose up db >> checkout_run.sh"
    sh "echo docker-compose run --rm flaskapp /bin/bash -c "cd /opt/services/flaskapp/src && python -c  'import database; database.init_db()'" >> checkout_run.sh"
    sh "echo docker-compose up"
    sshagent(['aws_pem']) {
    // 08.09.2018: Enter the test server and clone the git and run the docker compose
      sh "ssh -o StrictHostKeyChecking=no ubuntu@172.31.14.79 'bash -s' < checkout_run.sh"
          }

  }


}
